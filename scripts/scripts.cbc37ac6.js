"use strict";angular.module("angularEcsFlapApp",["ngAnimate","ngRoute","ngSanitize","ngTouch","hc.ngEcs"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("angularEcsFlapApp").run(["ngEcs",function(a){function b(){this.x=0,this.y=0}function c(){this.selector=null,this.$element=null}function d(){this.width=this.height=0,this.top=this.right=this.bottom=this.left=0}b.prototype.scale=function(a){return this.x*=a,this.y*=a,this},b.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},b.prototype.norm=function(){var a=this.mag();return this.x/=a,this.y/=a,this},c.prototype.select=function(a){return this.selector=a,this.$element=angular.element(document.querySelector(a))},c.prototype.transform=function(a){this.$element.css({"-ms-transform":a,"-webkit-transform":a,transform:a})},d.prototype.update=function(a){this.top=a.y,this.left=a.x,this.right=a.x+this.width,this.bottom=a.y+this.height,this.margin&&(this.top+=this.margin.top||0,this.bottom+=this.margin.bottom||0)},d.prototype.overlapY=function(a){return Math.max(0,Math.min(this.bottom,a.bottom)-Math.max(this.top,a.top))},d.prototype.overlapX=function(a){return Math.max(0,Math.min(this.right,a.right)-Math.max(this.left,a.left))},a.$c("position",b),a.$c("velocity",b),a.$c("acc",b),a.$c("bbox",d),a.$c("dom",c)}]),angular.module("angularEcsFlapApp").run(["$document","ngEcs","assemblies",function(a,b,c){function d(a){return 180*a/Math.PI}var e=400;b.$s("controls",{keys:{},$require:["control","velocity"],changeKey:function(a,b){this.keys[a.keyCode]=b},$started:function(){this.disabled=!1},$updateEach:function(a){(this.keys[32]||this.mousedown)&&(a.velocity.y=-e)},$added:function(){var b=this;a.on("keydown",function(a){b.changeKey(a||window.event,!0)}).on("keyup",function(a){b.changeKey(a||window.event,!1)}).on("mousedown touchstart",function(){b.mousedown=!0}).on("mousemove mouseup touchend touchcancel",function(){b.mousedown=!1})}}),b.$s("dom",{$require:["dom"],$addEntity:function(a){!a.dom.$element&&a.dom.selector&&a.dom.select(a.dom.selector)}}),b.$s("acceleration",{$require:["acc","velocity"],$updateEach:function(a,b){a.velocity.x+=a.acc.x*b,a.velocity.y+=a.acc.y*b}}),b.$s("velocity",{$require:["velocity","position"],$updateEach:function(a,b){a.position.x+=a.velocity.x*b,a.position.y+=a.velocity.y*b}}),b.$s("position",{$require:["position","dom","velocity"],$addEntity:function(a){var c=b.entities.canvas.dom.$element,d=a.dom.$element;a.position.x=d.prop("offsetLeft")-c.prop("offsetLeft"),a.position.y=d.prop("offsetTop")-c.prop("offsetTop")},getTranslation:function(a){var b="translate3d("+~~a.position.x+"px, "+~~a.position.y+"px, 0)";if("bird"===a._id){var c=-a.velocity.y/e,f=Math.max(c,-1),g=Math.max(c,-.5);b=b+" rotateZ("+d(Math.acos(f))+"deg) rotateY("+d(Math.asin(g))+"deg)"}return b},$started:function(){var a=this;this.$family.forEach(function(b){var c=b.dom.$element,d=c.prop("offsetWidth"),e=c.prop("offsetHeight");c.css({top:0,left:0,right:"auto",bottom:"auto",padding:0,margin:0,width:d+"px",height:e+"px",position:"absolute"}),b.dom.transform(a.getTranslation(b))})},$render:function(){for(var a,b=this.$family,c=b.length;c--;){a=b[c];var d=this.getTranslation(a);a.dom.$t!==d&&(a.dom.$t=d,a.dom.transform(d))}}}),b.$s("pipes",{$require:["pipe"],screen:null,$started:function(){for(var a=this.screen=b.entities.canvas,d=a.bbox.width/4,e=a.bbox.height;this.$family.length<5;){var f=angular.element('<img class="pipe" src="images/yeoman.png"></img>');angular.element(a.dom.$element).append(f),b.$e(angular.copy(c.pipe)).$add("dom",{$element:f})}b.systems.bbox.$started(),this.$family.forEach(function(b,c){b.position.x=a.bbox.width+c*d,b.position.y=e/2*Math.random(),b.pipe.cleared=!1})}}),b.$s("bbox",{$require:["dom","bbox"],$addEntity:function(a){var b=a.dom.$element;a.bbox.top=0,a.bbox.left=0,a.bbox.right=a.bbox.width=b.prop("offsetWidth"),a.bbox.bottom=a.bbox.height=b.prop("offsetHeight")},$started:function(){this.$family.forEach(function(a){a.dom.$element.css({width:a.bbox.width+"px",height:a.bbox.height+"px",padding:0,margin:0})})},$updateEach:function(a){a.position&&a.bbox.update(a.position)}}),b.$s("collision",{score:0,hiscore:0,screen:null,bird:null,pipes:null,miss:!1,hit:!1,crash:!1,startPos:null,time:0,$require:["bird"],$started:function(){this.screen=b.entities.canvas,this.pipes=b.$f(["pipe"]);var a=this.$family[0];a.$add("control",!0),this.startPos?(a.position.x=this.startPos.x,a.position.y=this.startPos.y):(this.startPos={},this.startPos.x=a.position.x,this.startPos.y=a.position.y),a.velocity.y=0,this.time=0,this.score=0,this.miss=!1,this.crash=!1,this.screen.dom.$element.css("background-color","#eee")},$updateEach:function(a,b){this.time+=b;var c=this.screen.bbox,d=a.bbox;if(d.bottom>c.bottom&&(a.position.y=c.bottom-d.height,this.crash=!0),!this.crash&&!this.miss)for(var e,f,g=this.pipes,h=g.length;h--;)e=g[h],f=e.bbox,e.pipe.cleared?f.right<c.left-c.width/8&&(e.position.x=9*c.width/8,e.pipe.cleared=!1):f.right<d.left?(e.pipe.cleared=!0,this.score++):f.left<d.right&&(d.top<f.top||d.bottom>f.bottom)&&(this.miss=!0,a.$remove("control"))},$render:function(){(this.miss||this.crash)&&(b.systems.controls.disabled||this.screen.dom.$element.css("background-color","#FF5858"),this.crash&&b.$stop()),this.score>this.hiscore&&(this.hiscore=this.score)}})}]),angular.module("angularEcsFlapApp").constant("assemblies",{canvas:{dom:{selector:"#canvas"},bbox:{}},pipe:{velocity:{x:-200,y:0},position:{x:0,y:0},pipe:{cleared:!1},bbox:{margin:{top:50,bottom:-50}}},bird:{dom:{selector:"#bird"},bbox:{},velocity:{x:0,y:0},acc:{x:0,y:2e3},position:{x:0,y:0},control:!0,bird:!0}}),angular.module("angularEcsFlapApp").controller("MainCtrl",["$window","$document","$scope","ngEcs","assemblies",function(a,b,c,d,e){function f(a){return angular.element(document.querySelector(a))}function g(){var a=window.innerWidth/(i.prop("offsetWidth")+60),b=window.innerHeight/(i.prop("offsetHeight")+20),c=Math.min(a,b);1>c&&(i.css("transform-origin","0 0"),i.css("transform","scale("+c+")"))}var h=this;h.game=d,d.$fps=60,h.message=function(){return h.game.$playing?h.game.systems.collision.score:"angular-ecs-flap"},h.hiscore=function(){return h.game.systems.collision.hiscore>0?"High Score: "+h.game.systems.collision.hiscore:"Built using angular-ecs"},h.click=function(a){a.target.blur(),d.$start()},d.$e("canvas",e.canvas),d.$e("bird",e.bird),b.on("keydown",function(a){d.$playing||32!==a.keyCode||d.$start()});var i=f(".container");g(),a.addEventListener("resize",g,!1)}]),angular.module("angularEcsFlapApp").controller("AboutCtrl",function(){});